
<html>

<head>
<title>infinite xkcd</title>
<script src="https://code.jquery.com/jquery-2.2.4.min.js" type="text/javascript" ></script>
<script src="http://rawgit.com/imakewebthings/waypoints/master/lib/jquery.waypoints.min.js" type="text/javascript" ></script>
<script src="http://rawgit.com/imakewebthings/waypoints/master/lib/shortcuts/infinite.min.js" type="text/javascript" ></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
</head>


<body>
<h1>Infinite xkcd</h1>



<div id="contents">


</div>

<button id="morebutton" class="infinite-more-link" type="button" onClick="more();">more ...</button>
<p id="done" style="display:none; font-size: xx-large;">That's all. :-(</p>



</body>

<script>

	var nextIds = [];

	function getStartId() {
		var query = window.location.search.substring(1);
		var vars = query.split("&");
		for (var i=0;i<vars.length;i++) {
			var pair = vars[i].split("=");
			if (pair[0] == "start") {
				return parseInt(pair[1]);
			}
		}

		window.history.replaceState("", "", "?start=" + 1);
		return 1;
	}


	var isFirst = true

	load(getStartId());



	function load(id) {
		$.get(id + ".json", function(data, status){
        	var entry = data;
        	var div = document.createElement("div");
			div.className = "item";

			div.innerHTML = `
				<h2><a href="${entry["url"]}">${entry["id"]}: ${entry["title"]}</a></h2>
				<p><img src="${entry["imgurl"]}" title="${entry["titletext"]}" style="max-width: 100%; height: auto;" /></p>
				<p>${entry["titletext"]}</p>
				<p><a href="${entry["explanationurl"]}">Explanation.</a> - <a href="?start=${entry["id"]}">Restart with this comic on top.</a></p>
			`
			document.getElementById('contents').appendChild(div);

			if(isFirst) {
				nextIds = entry.similar;
				// remove first
				nextIds.shift()
				isFirst = false;
			}

			if(nextIds.length > (entry.similar.length - 10)) {
				more();
			} else {
				waypoint.context.refresh();
				waypoint.enable();
			}
    	});

	}



	function more() {
		load(nextIds.shift());
		if(nextIds.length == 0) {
			document.getElementById('morebutton').style.display = "none";
			document.getElementById('done').style.display = "block";
		}
	}





	var waypoint = new Waypoint({
		element: document.getElementById('morebutton'),
		handler: function() {
			waypoint.disable();
			more();
		},
		offset: 'bottom-in-view',
		enabled: false
	})





</script>
</html>


